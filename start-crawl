#!/usr/bin/env python3
"""
Contract entrypoint. Scrapy Cloud will call this binary.
We run our Python script; you can override the command via START_CMD.
"""
import os, sys, json, os

def _as_argv(val: str):
    # Allow START_CMD='["python","zytepitchbook.py","--foo"]' or a plain string
    if not val:
        return None
    s = val.strip()
    if s.startswith("["):
        try:
            arr = json.loads(s)
            if isinstance(arr, list) and all(isinstance(x, str) for x in arr):
                return arr
        except Exception:
            pass
    return s.split()

spider = os.getenv("SHUB_SPIDER", "run")  # Scrapy Cloud passes this
if spider != "run":
    sys.stderr.write(f"Unknown spider: {spider}\n")
    sys.exit(2)

cmd = _as_argv(os.getenv("START_CMD")) or ["python", "zytepitchbook.py"]

# Append any job arguments (optional)
job_data = os.getenv("SHUB_JOB_DATA")
if job_data:
    try:
        data = json.loads(job_data)
        extra = data.get("job_cmd")
        if isinstance(extra, list) and all(isinstance(x, str) for x in extra):
            cmd.extend(extra)
    except Exception:
        pass

os.execvp(cmd[0], cmd)
